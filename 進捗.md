# 230301
 - MVCアーキテクチャっぽい処理の構造を考えてみた
 - いったんmainの基本となる動きを簡単に書いてみた。`main.js`をいじっている。また、`構想.ts`でクラスの構造とかを想像してメモしてある。
 - `main.js`は上に述べた通りだが、とりあえず遊んでみた。
   templateタグによる複製（クローン）と、イベントリスナーの設置はうまくできた
 - ドロップダウンに対するイベントリスナーを設定したが、一個しか正常に動かない。
   →結論、getElementById()なので一個しか対応してないから。クラス名によってelementsを取得してイベントリスナー設定すれば、全部に対応できる(しかし、眠いのでこれで終わる)
### なぐり書き
 - MVCとか考えずに、処理の流れだけを言葉にしてみる
 1. 一番最初は、ドロップダウンにリスナーを設定して、使い勝手のいい状態にする
 1. 次いで作成、検索ボタンにイベントリスナーを設定する
    - イベントリスナーが例えばclickを検知したら、それがイベントハンドラに伝わり、そしてcontrollerにアクションを伝える(そのときのデータもちゃんと伝えていけるように)
    そしてcontrollerがどの要素の上で起こったアクションなのか調べて、それに基づいてModelに指示を出す。※それこそ、ModelのクラスはCRUDUtilitiesみたいな名前でもいいかもしれない
    - 
 1. (検索の場合)入力された全情報をもとにデータベースを検索
 1. 検索結果を、シートから行をそのままコピーしてくる形の配列として取得
    - 実際には、その配列をさらに格納する配列、ということで二次元配列で取得することになると思う。
    - GAS側かjs側かは未定だが、もしor検索を実装するなら一致度を定義して関連度順に並ぶようにしたい
 1. 配列をいい感じに整形してProfileオブジェクトとして扱いやすくする
 1. ViewRendererのスタックにProfile情報を追加して、描画する
    - スタックに全部追加してからまとめて描画するか、スタックに追加するたびに描画するかは未定。ただし、イベントリスナー設定とかは最後にまとめてやったほうが楽だと思うので、まとめて描画するほうがいいとは思う

# 230305
 - データの更新がうまく反映されない問題が発生。`http-server --cache-"もしくはブラウザのdevtoolsのネットワークタブのキャッシュを無効化にチェック
 - 前回の課題であるドロップダウン修正は完了。
 - いくつかのクラスに分けることにした。※import, exportを使うには、サーバーを立ち上げてさらにtype="text/javascript"をtype="module"に変える必要がある
 - 作成ボタンを押すとコントローラーに指示が送られる処理を書くために、まずは作成ボタンを押したらトップのviewのコンテンツを取得するコードを書こうとしたが、init.js内でエラーが出て進めない。おそらくイベントリスナーを設定しても、コールバック関数内においては、初期化時のインスタンスではなく、別のインスタンスがthisにセットされることになるからだろう。
 - 「日程」ボタンを押したらコメント付きの日程が表示できる、というのはなくそう。代わりに、普通に日程のとこで'04/02"初めて参加"'というようにクォーテーションを使えばコメントをつけられるようにする
 - 厳密にMVCっぽくやるなら、イベントハンドラ、もしくはその中で呼ばれる関数をviewのほうにうつしても良い気がしてきた
 - ControllerやModelの分掌を意識して、ファイルを作成した。Modelでスプシとの通信を行う

# 230307
 - スプシのdoPost(e)あたりとの通信が全然うまくいかない。いろいろやって、なんとか「Webアプリにアクセスした状態でコンソールからfetch APIのコードを実行すると正しくレスポンスが帰ってくる」状態を作ることができた。一旦この問題は放置しておく。最終的なデプロイでは一度は絶対ブラウザでアクセスすることになるから、その状態なら正しくレスポンスが帰ってくると思ったため。
 参考サイト：https://teratail.com/questions/qodwcsntzavs5n
 - 結局、GASのWebアプリデプロイは弱そうだったのでgithub pagesを使うことにした
 - あと、doPostとの通信がうまくいかない件に関しては、ブラウザコンソール
 - GASのmodel.gsのコードの中で、targetRangeを選択するとこでDBSheet.getRange(lastRow+1,1,1,10); としているが、カラム数が増えたら10という数字を変える必要が有ることに注意せよ
 - なんやかんやで、createの一連の処理ができるようになった。ただしHTML側で出身を書く欄を忘れていたり、viewで各要素を取得するところでcontactを取得し忘れていたり、といった点を治す必要がある

# 230308
 - index.htmlのドロップダウンに項目を追加。data-value属性はあんま影響なさそうだが、なくすと将来困ったときの対処がわからなくなるかもなので、一旦全部"A"にしておいた
 - ボタンの形調整のために%nbsp;とかを入れたけど、jsで値を取得したときにどうなるのだろうか。注意する必要がある
   →結局どっちなんかわからんけど、trim()してるから関係なかった。
 - ボタンテキストのデフォルト値:経験、学科、入会意思を設定した。また、「未選択」というドロップダウンのオプションもつけようと思うので、その場合にはjsのview側で""とみなす処理を書く必要がある
 - createやsearchのPOSTリクエストとは別に、(5分？もっと短い？ぐらいでタイムアウトを設定してから)「検索していてこれとこれとこれを表示中である(Infoを保存しておく)」という状態で待機させておいて、もし他にupdateリクエストとかがあって更新されたら、その内容をクライアントに送る、というのを作っても良いかも。
 問題点：同時実行回数の制限に引っかかる可能性
 - ↑とは別の方法として、クライアントがページを表示している間は、定期的に情報が変わってないかの確認のリクエストを送り続けるという方法も考えられる。これなら同時実行制限を回避できそう。表示中はずっとリクエストが定期的に送られるのも嫌なら、タイムアウトを設けてそれ以降は定期確認を行わない（ただし何かイベントが発生したら、もとに戻る）というのもあり
 - 検索機能の、Controller.read()の途中まで書いた。ただしテストはしてない。Viewオブジェクトをどう使うか、という構想もそこに書いてある。

# 230309
 - 検索結果にデータID(=列番号)があると更新の際非常に便利だと思った。
   最初はグローバルにviewStackなる配列を作ってviewとIDをセットにして入れてIDを永続化しようと思ったが、普通に各テンプレートのclassに"id-11"みたいな感じでクラスを設定すれば簡単に永続化できる。
 - だからViewのgetInfoの中に、idを取得する文も追加したい。ただし今はreadの作成中なので、またあとで。
 - 作成時のレスポンスにIDも含めて、view-top(作成および検索を担う部分)にもclassにIDを設定すれば、「作成」が複数回押されたときに重複していませんか？とチェックすることができる→じゃあ先に作っても良いかも。一応現在何の作業の途中だったのかメモしておくと、model.gsのstatic read()を作ってる途中だった。
 - ↑**最終的には、「作成」をしたときに最終的に登録された値が検索結果のように表示されたら便利だと思う。だから、#view-topのdivタグにdata-idをつける必要性はもはやなくなる**（なぜならば、検索結果の形式で表示しているviewのほうにつければよいし、通信が成功したこともわかりやすくなるからだ）
 - とりあえず検索処理を行うGASは書けた。次は検索結果を表示する機能を作る
 - readの引数のviewインスタンスは、#view-topに対応するものであるから、各Infoを表示するのはまた別のviewインスタンスであるべきであることに注意。
 - 検索を押したら過去の検索結果を消してから検索を開始するところまで書けた

 # 230310
 - 今からやるべき作業は、検索結果の「更新」機能の実装である。
 - updateの実装までするとなると、いよいよデータの競合が問題になってくる。しかし一旦updateだけを実装しよう。競合への処理は多少複雑になっても良く、updateのロジックが簡潔になればよい
 - htmlのviewテンプレートの方には「適用」(apply)、「更新」(update)、「削除」(delete)のボタンがあるが、ややこしいので適用ボタンを消して、更新を編集の意味でのupdateにして、リロードしたければ別途ボタンを作る。しかしリロードとかの話になってくると、競合の処理に関する話になってくるので今は考えない
 - 競合の処理について今思っていることを簡単に書くと、updateリクエストを送る際に、もともと検索結果として返ってきたInfoがどんなものであったか、スタックに記憶しておき、それと変更後のInfoを一緒にスプシに送る。で、もともとのInfoとスプシ内の情報を比較して、同じであれば競合なし、違っていれば競合が起こっている。
 そしてデータの競合が起こっていることとそのデータを提示するalertを出し、強制的にデータを適用するか、差分をいろいろ計算して一旦viewに表示するか、更新を中止するかを選べるようにする。というイメージ。**このへんはたぶんふつうに大変だと思う**
 - だから、一旦は「適用」ボタンを削除して、更新ボタンにupdate処理を実装していく
 - とその前に、init.jsを廃止して、初期化自体はViewインスタンスメソッドinit()にやらせて、その際のイベントハンドラをeventHandler.js内のstaticメソッドにやらせるように変更する→できたので、更新ボタンの処理にうつる
 - 今ふとcontroller.jsの95行目に謎のconst infoArr = modelResponse.infoArr;という文があったので消しといた。ifの内側でinfoArrにアクセスされているので、この謎のinfoArrは絶対いらないはずだから消しといた
 - issue:**ドロップダウンボタンは、未選択かどうか、また、その種類が色でわかったほうが絶対いい。色データはHTML側に埋め込んでおくとして、それに従ってボタンの色を変える仕組みが必要だ。**
 - issue:**timestampも、Infoに入れてよくね？？そしたら更新日時による並び替えとかできるようになる**
 - コンフリクトへの対応はしていないが、とりあえずupdateの処理は書けた。次はdeleteだ。
 - deleteはもちろん実際に削除するのではなく、フラグをつけることにする。
   シートの関係なさそうな列にフラグをつけるのもありだが、備考のとこに`@delete`とつけることにする。@deleteが含まれてたら、削除扱いにするという意味だ。同じようにして「重要」なら@importantとかもありだろう。
 - 削除を可能にするのは、`"delete"`リクエストのときのみである必要はない。むしろ、updateでも`@delete`を見つけたら削除をするし、deleteの処理も本質的には@deleteをつけた上でupdate処理をする、だからupdate処理を作り直していく必要がある
 - ↑やっぱり、deleteもupdateも同じ処理を呼び出しはするが、deleteからupdateを直接呼び出すようなことはやめたほうがいいかも。共通する処理は他のメソッドにまとめとくぐらいが、コードの統一性の観点からもちょうどいいと思う。
 - model.gsのupdateの処理を一部作り変えた。
   - deleteフラグがたっていたら、データを更新しつつもデータベースで非表示にして、レスポンスのoptionにoption.delete = trueを加えることにした。
 - model.gsのreadの処理を一部作り変えた
   - 削除フラグが立っており、なおかつ検索条件の中で"@delete"と指定されていなかった場合にはその人の情報を検索結果に含めないように作りかえた
   - 削除フラグが立っており、かつ、検索条件の中で"@delete"と指定されていた場合には、検索結果に含めることができる。なお、ここの処理より前の段階で、普通にcommentの内容で絞り込みを行う時に"@delete"がついた情報しか残らなくなるので、結果的にレスポンスの配列`infoArr: Info[]`には削除済みの情報しか表示されない
 - 次はmodel.gsのdeleteを作るとこから。思ってたよりupdateの改造は簡単だったし、deleteでそのままupdateを呼び出しちゃってもよかったけど、deleteの場合は情報の更新を行わない、と決めたのでdeleteは別で作ろう。
 - **やっぱりupdateとdeleteは共通化したほうが良い気がしてきた**。こいつはたぶん重複してるやろなーって思ったときとか、コメントに「多分重複してる」って書いてから削除を押したくなることも多いはずだ。だからdeleteはクライアント側で多少いじくって、modelの処理はupdate()そのままでいいと思う
 - issue:**deleteもupdateを利用した作り方をしているのに、なぜかエラーになる。CORSポリシーにひっかかるとかなんとか。**まだGASプログラム単体のテスト等はしてないので、まずはGASが悪いのかクライアントサイドが悪いのかを特定するところからだ。→結局、doPost.gsのswitch文の中でModel.deleteを呼び出すべきところでModel.deteleと入力ミスしていた
 - issue:**"@delete"とかが消えたら、データベースで再表示（非表示を解除）するようにしなければ！！**

# 230313
 - 検索条件の年数のとこを指定すると、バグが起きる問題を改善
   POSTで返ってきたエラーメッセージには`searchResults[i][(COLUMN_NUM[key] - 1)].includes is not a function`と書かれており、年数が半角数字の数値型として認識されたことが原因であると思われる。そこでメソッドをつけるとこ全体をString()でラップして解決。ちなみに他にもincludesを使っている場所がcomment内のフラグを検査する場所にもあったのだが、もし仮にcommentに半角数字だけが入力されたら同様のエラーが起こりうるので、全部String()でラップすることにした
 - タッチでviewの色が少し変わるようにしてみた。色を変える処理はViewのインスタンスメソッドsetBackground(BackGroundとしないよう注意！)に書き、またイベントハンドラをeventHandler.jsに書いた。
   View.prototype.setBackground()は@deleteや@importantを検知したときの背景色変更にも使えるはずだ
 - **@deleteや@importantに対する色変更を、何をもとに判断するのかは考えどころである。**実際にInfoオブジェクトの値をチェックして色を変化させるのか、それともGASと通信した結果のoption(←これの命名も変えたい。レスポンスに関してはoptionじゃなくてreportとしたほうが自然)に,deleteプロパティ:trueとか書いておいて、それを見て色を変えるのもあり。

# 230315
 - データ作成時にデータベースを検索して、同じ人である可能性が高い場合には警告を出して本当に変更するかどうか確認するのがいいかも